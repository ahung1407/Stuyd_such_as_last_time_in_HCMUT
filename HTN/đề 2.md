Chào bạn, dựa trên yêu cầu của bạn và nội dung các bài giảng (Lecture 1-5) cùng tài liệu tham khảo, tôi xin thiết kế **Đề thi số 2**.

Đề thi này sẽ khai thác các khía cạnh khác của môn học so với Đề số 1, tập trung sâu hơn vào **giao tiếp Bus**, **Lập trình C hiệu quả**, **RTOS**, và bài toán thiết kế **Máy giặt tự động** (được gợi ý trong Lecture 4).

---

# ĐỀ THI CUỐI KỲ MẪU SỐ 2: HỆ THỐNG NHÚNG (CO3053)

**Thời gian:** 90 phút
**Hình thức:** Trắc nghiệm (30%) + Tự luận (70%)
**Tài liệu:** Được sử dụng 02 tờ A4.

---

## PHẦN I: TRẮC NGHIỆM & CÂU HỎI NGẮN (30 Điểm)

**Câu 1:** Đặc điểm nào sau đây phân biệt giao tiếp **SPI** so với **I2C**?
A. SPI chỉ sử dụng 2 dây tín hiệu (SDA, SCL).
B. SPI là giao tiếp song công (Full-duplex) và thường có tốc độ cao hơn I2C.
C. SPI sử dụng địa chỉ 7-bit để chọn thiết bị tớ (Slave).
D. SPI có cơ chế "Clock stretching" để đồng bộ hóa tốc độ.
_(Gợi ý: Xem lại đặc tả kỹ thuật của SPI và I2C,,)_

**Câu 2:** Trong mô hình RTOS, vấn đề **"Priority Inversion"** (Đảo ngược độ ưu tiên) xảy ra khi nào?
A. Khi tác vụ có độ ưu tiên thấp chiếm giữ tài nguyên (Mutex) mà tác vụ có độ ưu tiên cao đang cần.
B. Khi hệ thống hết bộ nhớ Stack.
C. Khi hai tác vụ cùng độ ưu tiên chạy song song.
D. Khi vi xử lý chuyển sang chế độ Sleep để tiết kiệm năng lượng.
_(Gợi ý: Xem lại slide về RTOS Challenges và sự cố Mars Pathfinder,)_

**Câu 3:** Kết quả của đoạn macro sau là gì nếu `x = 2`: `#define SQUARE(a) a*a` khi gọi `SQUARE(x+1)`?
A. 9 (Tính toán đúng: (2+1)*(2+1))
B. 5 (Do lỗi thay thế văn bản: 2+1*2+1 = 2+2+1)
C. 6 (Lỗi biên dịch)
D. 4 (Chỉ tính x*x)
*(Gợi ý: Xem lại lỗi thường gặp với #define trong lập trình C nhúng,)\*

**Câu 4:** Trong quy trình phát triển phần mềm nhúng (Development Process), bước nào thực hiện việc chuyển đổi code từ "Host Computer" sang mã máy chạy trên "Target System"?
A. Hardware-Software Partitioning.
B. Cross-compilation (Biên dịch chéo).
C. Simulation (Mô phỏng).
D. Requirement Gathering.
_(Gợi ý: Xem lại khái niệm Cross-platform development,,)_

**Câu 5:** (Câu hỏi ngắn) Phân biệt **Hard Real-time** và **Soft Real-time**. Cho một ví dụ về Hard Real-time trong ô tô.
_(Gợi ý: Dựa trên hậu quả của việc trễ hạn (deadline),,)_

**Câu 6:** (Câu hỏi ngắn) Tại sao việc sử dụng biến toàn cục (global variable) được chia sẻ giữa chương trình chính (Main loop) và trình phục vụ ngắt (ISR) lại có thể gây ra lỗi? Cần dùng từ khóa gì để khắc phục một phần vấn đề này?
_(Gợi ý: Vấn đề Shared-data và từ khóa volatile,,)_

---

## PHẦN II: TỰ LUẬN - THIẾT KẾ HỆ THỐNG (70 Điểm)

### Bài toán: Hệ Thống Điều Khiển Máy Giặt Tự Động (Smart Washing Machine)

Bạn hãy thiết kế khối điều khiển cho một máy giặt đơn giản với các yêu cầu sau:

- **Đầu vào:**
  - 3 Nút nhấn: `START`, `PAUSE`, `STOP`.
  - Cảm biến mức nước: `Level_Sensor` (Trả về: `EMPTY`, `FULL`).
  - Cảm biến nắp máy: `Lid_Sensor` (Trả về: `OPEN`, `CLOSED`).
- **Đầu ra:**
  - Van cấp nước: `Valve_In` (ON/OFF).
  - Động cơ quay: `Motor` (ON/OFF).
  - Van xả nước: `Valve_Out` (ON/OFF).
  - Đèn báo trạng thái: `LED_Status` (Sáng/Tắt/Nhấp nháy).

**Hoạt động:**

1.  **Trạng thái chờ (IDLE):** Máy đứng yên, đèn tắt. Nhấn `START` để bắt đầu chu trình.
2.  **Cấp nước (FILLING):** Mở `Valve_In` cho đến khi `Level_Sensor` báo `FULL`.
3.  **Giặt (WASHING):** Động cơ `Motor` chạy trong 15 phút.
4.  **Xả nước (DRAINING):** Mở `Valve_Out` cho đến khi `Level_Sensor` báo `EMPTY`.
5.  **Vắt (SPINNING):** Động cơ `Motor` chạy tốc độ cao trong 5 phút.
6.  **Hoàn thành (DONE):** Đèn nhấp nháy 3 lần, sau đó quay về `IDLE`.
7.  **An toàn:** Bất kỳ lúc nào nắp mở (`Lid_Sensor` = `OPEN`), máy phải dừng động cơ ngay lập tức (về trạng thái `PAUSED`). Nhấn `STOP` bất kỳ lúc nào sẽ xả hết nước và về `IDLE`.

---

### Yêu cầu thực hiện:

**Câu 1 (15 điểm): Kiến trúc phần cứng**
a. Vẽ sơ đồ kết nối phần cứng (Hardware Block Diagram) giữa Vi điều khiển (MCU) và các thiết bị ngoại vi kể trên.
b. Cảm biến mức nước và Nắp máy nên được kết nối theo cơ chế nào: **Polling** (Hỏi vòng) hay **Interrupt** (Ngắt)? Giải thích sự lựa chọn của bạn cho từng loại cảm biến dựa trên tính chất phản hồi của chúng.
_(Gợi ý: Cảm biến nắp liên quan đến an toàn, cảm biến nước diễn ra chậm,,)_

**Câu 2 (30 điểm): Thiết kế Máy trạng thái (FSM)**
Vẽ biểu đồ máy trạng thái (State Machine Diagram) chi tiết cho hệ thống.

- Cần thể hiện rõ các trạng thái: `IDLE`, `FILLING`, `WASHING`, `DRAINING`, `SPINNING`, `PAUSED`.
- Xử lý các sự kiện chuyển đổi: Nút nhấn, Cảm biến đầy/cạn, Timer hết giờ.
- **Lưu ý đặc biệt:** Xử lý logic khi nắp mở (`Lid_Open`) từ trạng thái `SPINNING` hoặc `WASHING` sang `PAUSED` và quay lại khi đóng nắp + nhấn `START`.
  _(Gợi ý: Tham khảo bài tập về Máy giặt trong Lecture 4,)_

**Câu 3 (20 điểm): Thiết kế Lưu đồ giải thuật (Flowchart)**
Vẽ lưu đồ giải thuật cho hàm `System_Safety_Check()` chạy trong vòng lặp chính hoặc ngắt Timer.

- Nhiệm vụ: Kiểm tra `Lid_Sensor`.
- Nếu Nắp mở VÀ Máy đang chạy (`Motor` đang ON): Tắt Motor ngay lập tức, chuyển trạng thái hệ thống sang `PAUSED`, Bật đèn báo lỗi.
- Nếu Nắp đóng: Không làm gì hoặc cho phép hệ thống tiếp tục (tùy logic bạn chọn).
  _(Gợi ý: Sử dụng ký hiệu hình thoi cho điều kiện kiểm tra, hình chữ nhật cho hành động,)_

**Câu 4 (5 điểm): Kỹ thuật lập trình C**
Giả sử thanh ghi điều khiển động cơ `MOTOR_CTRL` (8-bit) nằm tại địa chỉ `0x40001000`.
Bit 0 điều khiển Bật/Tắt (1=ON, 0=OFF).
Bit 1 điều khiển Chiều quay (1=Thuận, 0=Nghịch).
Hãy viết một dòng lệnh C (sử dụng pointer và bitwise operation) để **chỉ bật động cơ** (Bit 0 lên 1) mà **không làm thay đổi** chiều quay (Bit 1) hoặc các bit khác.
_(Gợi ý: Dùng phép toán Bitwise OR,)_

---

### Gợi ý đáp án nhanh (Dành cho việc tự chấm):

- **Trắc nghiệm:** 1.B, 2.A, 3.B (Lỗi kinh điển), 4.B, 5. Hard Real-time: Phanh ABS, Túi khí (sai là nguy hiểm tính mạng).
- **Tự luận Câu 1:** Nắp máy nên dùng **Interrupt** (vì cần phản ứng ngay lập tức để bảo vệ người dùng). Mức nước có thể dùng **Polling** (vì nước chảy vào chậm, không cần xử lý tức thì microsecond).
- **Tự luận Câu 2:** Máy trạng thái cần chú ý mũi tên từ mọi trạng thái hoạt động (Washing/Spinning) về `PAUSED` khi mở nắp.
- **Tự luận Câu 4:**
  `*(volatile unsigned char *)0x40001000 |= (1 << 0);`
  Hoặc: `*(volatile uint8_t *)0x40001000 |= 0x01;`
  (Từ khóa `volatile` rất quan trọng khi truy cập thanh ghi phần cứng).
